---
title: "Global STP Analysis"
author: "Matt"
date: "November 12, 2014"
output: html_document
---

### Load required libraries and move into correct directory

```{r}
library("phyloseq")
library("ggplot2")
library("plyr")
library("vegan")
library("grid")
library("directlabels")
setwd('~/microbiome/subprojects/2.16S_MiSeq/2.data/3.mothur/')
```

### Import data into R studio

First .shared 'otu matrix' from mothur

```{r}
sharedFile = read.table('micro.final.shared')
sharedFile = t(sharedFile)
rownames(sharedFile) = sharedFile[,1]
colnames(sharedFile) = sharedFile[2,]
sharedFile = sharedFile[,2:234]
sharedFile = sharedFile[4:37368,]
class(sharedFile) <- "numeric"
```

Import subsampled otu matrix (7779 seqs)

```{r}
sharedsubFile = read.table('micro.final.clean.0.03.subsample.shared')
sharedsubFile = t(sharedsubFile)
rownames(sharedsubFile) = sharedsubFile[,1]
colnames(sharedsubFile) = sharedsubFile[2,]
sharedsubFile = sharedsubFile[,2:219]
sharedsubFile = sharedsubFile[4:14839,]
class(sharedsubFile) <- "numeric"
```

Import taxonomy file

```{r}
taxFile = read.table('micro.final.0.03.cons.taxonomy', header=T, sep='\t')
rownames(taxFile) = taxFile[,1]
taxFile = taxFile[,3:9]
taxFile = as.matrix(taxFile)
```

Import metadata - ie. site, type, etc..

```{r}
metaFile = read.table('pools.metaData2', header=T, sep='\t')
rownames(metaFile) = metaFile[,1]
metaFile = metaFile[,2:6]
```

### Create phyloseq object

```{r}
OTU = otu_table(sharedFile, taxa_are_rows = TRUE)
OTUsub = otu_table(sharedsubFile, taxa_are_rows = TRUE)
TAX = tax_table(taxFile)
META = sample_data(metaFile)
physeq = phyloseq(OTU, TAX, META)
physeqSub = phyloseq(OTUsub, TAX, META)
physeq
physeqSub
```

Get rid of any OTUs not present in any samples and get relative abundance

```{r}
microSub <- prune_taxa(taxa_sums(physeqSub) > 0, physeqSub)
microSubRel = transform_sample_counts(microSub, function(x) x / sum(x) )
microSubRelFilt = filter_taxa(microSubRel, function(x) mean(x) > 1e-5, TRUE)
```

Split into species 

```{r}
microSubRelFiltSpist <- subset_samples(microSubRelFilt, species=='Stylophora pistillata')
microSubRelFiltPdami <- subset_samples(microSubRelFilt, species=='Pocillopora damicornis')
microSubRelFiltPverr <- subset_samples(microSubRelFilt, species=='Pocillopora verrucosa')
microSubRelFiltSea <- subset_samples(microSubRelFilt, species=='seawater')
```

### Richness / diversity plots on full dataset

Look at observed OTUs, predicted OTUs (chao1) and then the shannon diversity index.

```{r, fig.width = 8}
microRich = plot_richness(physeq, x = 'species', measures = c('Chao1', 'Shannon', 'observed'), color = 'site')
microRich
```

Seawater is quite a bit higher and makes the coral results a bit hard to see - drop seawater and repeat

```{r, fig.width = 8}
physeqCoral <- subset_samples(physeq, species!="seawater")
microCoralRich = plot_richness(physeqCoral, x = 'species', measures = c('Chao1', 'Shannon', 'observed'), color = 'site')
microCoralRich
microCoralRich + geom_boxplot(data = microCoralRich$data, aes(x = species, y = value, color = NULL), alpha = 0.1)
```

# Relative abundance of otus in all Stylophora pistillata samples

```{r, fig.width = 10}
microSubRelFiltSpistFilt = filter_taxa(microSubRelFiltSpist, function(x) mean(x) > 1e-2, TRUE)
spistBar <- plot_bar(microSubRelFiltSpistFilt, fill="Genus", title='Stylophora pistillata')
spistBar
```

Looks like some variability between the samples but Endozoicomonas is spread throughout. Its a bit difficult to see which sites are which - I'll facet out the sites.

```{r, fig.width= 10}
microSubRelFiltSpistFilt = filter_taxa(microSubRelFiltSpist, function(x) mean(x) > 1e-2, TRUE)
spistBar <- plot_bar(microSubRelFiltSpistFilt, fill="Genus", title='Stylophora pistillata')
spistBar + facet_wrap(~site, scales='free')
```

Again quite a bit of variability between and within sitees.

The Red Sea has the most samples and is a bit hard to see at this scale - I'll take a closer look at these reefs.

```{r, fig.width= 10, fig.height = 8}
microSubRelFiltSpistFilt = filter_taxa(microSubRelFiltSpist, function(x) mean(x) > 1e-2, TRUE)
microSubRelFiltSpistFiltRedSea <- subset_samples(microSubRelFiltSpistFilt, site=="RedSea")
spistRedSea <- plot_bar(microSubRelFiltSpistFiltRedSea, fill="Genus", title='Stylophora pistillata in the Red Sea')
spistRedSea + facet_wrap(~reef, scales="free")
```

# Relative abundance of pocillopora verrucosa otus bar plot

```{r, fig.width = 10}
microSubRelFiltPverrFilt = filter_taxa(microSubRelFiltPverr, function(x) mean(x) > 1e-2, TRUE)
pverrBar <- plot_bar(microSubRelFiltPverrFilt, fill="Genus", title='Pocillopora verrucosa')
pverrBar + facet_wrap(~site, scales="free")
```

# Relative abundance of pocillopora damicornis otus bar plot

```{r, fig.width = 10}
microSubRelFiltPdamiFilt = filter_taxa(microSubRelFiltPdami, function(x) mean(x) > 1e-2, TRUE)
pdamiBar <- plot_bar(microSubRelFiltPdamiFilt, fill="Genus", title='Pocillopora damicornis')
pdamiBar + facet_wrap(~site, scales="free")
```

# Relative abundance of seawater otus bar plot

```{r, fig.width = 10}
microSubRelFiltSeaFilt = filter_taxa(microSubRelFiltSea, function(x) mean(x) > 5e-3, TRUE)
seaBar <- plot_bar(microSubRelFiltSeaFilt, fill="Genus")
seaBar + facet_wrap(~site, scales="free")
```




